// ==========================================
// Tissaia - Forensic Restoration Engine
// Type Definitions v2.0
// ==========================================

export type MimeType = 'image/jpeg' | 'image/png' | 'image/webp' | 'image/heic';
export type ModelName = 'gemini-3-pro-preview' | 'gemini-3-pro-image-preview';
export type ScanLifecycleState = 'UPLOADING' | 'SCANNED' | 'CROPPING' | 'RESTORING' | 'DONE';

// --- Shared Configurations ---

export interface ModelConfig {
  model_name: ModelName;
  temperature: number;
  top_k?: number;
  max_output_tokens?: number;
  safety_settings?: 'BLOCK_NONE' | 'BLOCK_ONLY_HIGH' | 'BLOCK_MEDIUM_AND_ABOVE';
}

export interface UiFeedback {
  loading_message?: string;
  success_message?: string;
  loading_states?: string[];
}

// --- Stage 1: Ingestion (Local Heuristics) ---

export interface HeuristicsEngine {
  method: 'Analiza Krawędzi i Transformata Hougha';
  library: 'OpenCV.js (WASM)';
  parameters: {
    gaussian_blur_kernel: number;
    canny_threshold_1: number;
    canny_threshold_2: number;
    hough_min_line_length: number;
    hough_max_line_gap: number;
  };
}

export interface StageIngestionConfig {
  name: string;
  description: string;
  timeout_ms: number;
  config: {
    heuristics_engine: HeuristicsEngine;
    thumbnail_generation: {
      max_width: number;
      quality: number;
      format: MimeType;
    };
  };
  ui_feedback: UiFeedback;
}

// --- Stage 2: Detection (Vision AI) ---

export interface DetectionPromptEngineering {
  system_role: string;
  task_directive: string;
  output_format_enforcement: string;
  strategy_fallback: string;
}

export interface StageDetectionConfig {
  name: string;
  description: string;
  service_endpoint: string; // e.g. "geminiService.analyzeImage"
  model_config: ModelConfig;
  prompt_engineering: DetectionPromptEngineering;
  error_handling: {
    retry_count: number;
    fallback_action: 'SWITCH_TO_MANUAL_CROP_UI' | 'ABORT';
  };
}

// --- Stage 3: Smart Crop (Client-Side) ---

export interface HygieneCutRule {
  enabled: boolean;
  margin_percentage: number; // 0.10 for 10%
  reason: string;
}

export interface StageSmartCropConfig {
  name: string;
  description: string;
  execution_context: 'Browser Main Thread' | 'WebWorker';
  logic_rules: {
    coordinate_mapping: string;
    hygiene_cut: HygieneCutRule;
    rotation_handling: {
      auto_rotate: boolean;
      background_fill: string;
    };
    output_format: {
      mime: MimeType;
      quality: number; // 0.0 - 1.0
      encoding: 'base64';
    };
  };
}

// --- Stage 4: Alchemy (Restoration AI) ---

export interface PromptStep {
  id: 'OUTPAINTING' | 'HYGIENE' | 'DETAIL' | 'COLOR_GRADING';
  instruction: string;
  weight?: string; // "High", "Medium", etc.
  negative_prompt?: string;
  constraint?: string;
  reference?: string;
}

export interface StageAlchemyConfig {
  name: string;
  description: string;
  service_endpoint: string;
  cost_estimation: string;
  model_config: ModelConfig;
  prompt_directives: {
    structure: {
      role: string;
      input_context: string;
      steps: PromptStep[];
    };
  };
  ui_feedback: UiFeedback;
}

// --- ROOT PIPELINE CONFIGURATION ---

export interface PipelineStages {
  STAGE_1_INGESTION: StageIngestionConfig;
  STAGE_2_DETECTION: StageDetectionConfig;
  STAGE_3_SMART_CROP: StageSmartCropConfig;
  STAGE_4_ALCHEMY: StageAlchemyConfig;
}

export interface GlobalConstraints {
  max_concurrent_restorations: number;
  max_input_file_size_mb: number;
  supported_mime_types: MimeType[];
  security_sanitization: boolean;
}

export interface DataContractScanFile {
  id: string; // UUID
  lifecycle_state: ScanLifecycleState;
  metrics: {
    original_resolution: string; // "WxH"
    processing_time_ms: number;
  };
}

/**
 * Główny interfejs konfiguracyjny systemu Tissaia.
 * Importuj ten typ w plikach konfiguracyjnych.
 */
export interface PipelineConfiguration {
  pipeline_configuration: {
    meta: {
      id: string;
      revision: string;
      last_updated: string;
      environment: 'production' | 'development' | 'staging';
    };
    global_constraints: GlobalConstraints;
    stages: PipelineStages;
    data_contracts: {
      ScanFile: DataContractScanFile;
    };
  };
}