{
  "pipeline_name": "TISSAIA V14: NECRO_OS",
  "version": "14.0.0",
  "description": "Automated pipeline for extraction, forensic restoration, and HDR remastering of vintage photo scans.",
  "objective": "100% segmentation accuracy via human-in-the-loop verification followed by generative enhancement.",
  "phases": [
    {
      "phase_id": "PRE-A",
      "name": "Integrity Verification & Manifest Generation",
      "type": "Interactive/Manual",
      "steps": [
        {
          "step_id": "VISUAL_INGESTION",
          "action": "Load raw scans from input source",
          "input_format": ["ZIP", "Folder"],
          "supported_extensions": [".jpg", ".jpeg", ".png"]
        },
        {
          "step_id": "INTERACTIVE_ANNOTATION",
          "tool": "Streamlit Interface",
          "process": "Operator visually counts photos per scan and inputs integer values.",
          "rationale": "Eliminates OCR/Counting errors by leveraging human cognition."
        },
        {
          "step_id": "MANIFEST_GENERATION",
          "action": "Generate 'Lista kontrolna.txt'",
          "data_structure": "{Filename: Expected_Count}",
          "output_format": "filename.jpg <count> zdjÄ™cia"
        },
        {
          "step_id": "VALIDATION_GATE",
          "condition": "Input_Files == Manifest_Entries",
          "on_fail": "CRITICAL_STOP",
          "on_pass": "PROCEED_TO_PHASE_A"
        }
      ]
    },
    {
      "phase_id": "A",
      "name": "Input Analysis",
      "type": "Automated",
      "input": "Single scan image + Manifest entry",
      "challenges_handled": [
        "Touching photos (Zero gap)",
        "Torn photos (Over-segmentation risk)",
        "Rotated content"
      ]
    },
    {
      "phase_id": "B",
      "name": "Adaptive Segmentation (The Loop)",
      "type": "Heuristic Algorithmic Loop",
      "goal": "Detected_Count == Expected_Count",
      "strategies": [
        {
          "level": 1,
          "name": "Standard Watershed",
          "algorithm": "Marker-Controlled Watershed (OpenCV)",
          "preprocessing": "Otsu Thresholding",
          "marker_generation": "Distance Transform (Ratio: 0.2) + Connected Components"
        },
        {
          "level": 2,
          "name": "Brute Force Parameter Search",
          "trigger": "Level 1 Failed",
          "parameters": {
            "distance_ratio_sweep": [0.05, 0.7],
            "kernel_size_sweep": [[3,3], [5,5], [7,7]]
          }
        },
        {
          "level": 3,
          "name": "The Glue Protocol",
          "trigger": "Detected > Expected (Torn Photo Detection)",
          "action": "Aggressive Morphological Closing",
          "kernel_max": [15, 15],
          "goal": "Merge disjointed fragments into single mask"
        },
        {
          "level": 4,
          "name": "Fallback",
          "trigger": "All Levels Failed",
          "action": "Simple Contour Detection on Adaptive Thresholding"
        }
      ]
    },
    {
      "phase_id": "C",
      "name": "Surgical Extraction",
      "type": "Image Processing",
      "steps": [
        {
          "step_id": "MASK_APPLICATION",
          "action": "Apply mask to ORIGINAL unblurred RGB image",
          "reason": "Preserve original pixel fidelity"
        },
        {
          "step_id": "SMART_CROP",
          "action": "Crop 10% safety margin from all edges",
          "output_label": "Safe_Zone",
          "reason": "Remove jagged scanning artifacts; force AI regeneration"
        }
      ]
    },
    {
      "phase_id": "KERNEL",
      "name": "Generative Restoration",
      "engine": "Google Gemini 3 Pro Vision",
      "models": {
        "reasoning": "gemini-3-pro-preview",
        "generation": "gemini-3-pro-image-preview"
      },
      "input_data": "Base64 encoded Safe_Zone JPEG",
      "system_instructions": {
        "role": "Forensic Photo Restoration Specialist",
        "tasks": [
          {
            "id": "OUTPAINTING",
            "instruction": "Regenerate missing 10% borders, fixing geometry."
          },
          {
            "id": "DIGITAL_HYGIENE",
            "instruction": "Remove scan lines, dust, fungus, paper texture."
          },
          {
            "id": "FORENSIC_DETAIL",
            "instruction": "Reconstruct facial landmarks (iris symmetry, skin micro-texture) without smoothing."
          },
          {
            "id": "HDR_REMASTERING",
            "instruction": "Apply 'Kodak Portra 400' color science and 'Rembrandt' studio lighting."
          }
        ]
      }
    },
    {
      "phase_id": "POST",
      "name": "Post-Processing",
      "steps": [
        {
          "step_id": "SUPER_SHARPEN",
          "action": "Local contrast enhancement + Unsharp Masking",
          "library": "PIL.ImageEnhance"
        },
        {
          "step_id": "FINAL_OUTPUT",
          "destination": "odnowione_final/",
          "format": "High-Fidelity PNG"
        }
      ]
    }
  ]
}